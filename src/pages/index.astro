---
import Layout from "../layouts/Layout.astro";
import Main from "../components/Main.astro";
import Benefits from "../components/Benefits.astro";
import Reasons from "../components/Reasons.astro";
import Media from "../components/Media.astro";
import PopUp from "../shared/components/Modal.astro";
import { MODAL_DATA } from "../shared/data/modal_data";
import "../styles/reset.css";

// Server-side: Get country from request headers or IP
const clientIP = Astro.request.headers.get("cf-connecting-ip") ||
  Astro.request.headers.get("x-forwarded-for")?.split(",")[0] ||
  "unknown";

let isBY = false;

if (clientIP && clientIP !== "unknown") {
  try {
    const token = "cc6c23fd5592bb";
    const response = await fetch(`https://ipinfo.io/${clientIP}`, {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });
    const data = await response.json();
    isBY = data.country === "BY";
  } catch (err) {
    console.error("Error fetching IP info:", err);
  }
}

---

<!--<script>-->
<!--  let isBY = false;-->
<!--  fetch('https://api64.ipify.org?format=json')-->
<!--    .then(r => r.json())-->
<!--    .then(data => {-->
<!--      const token = "cc6c23fd5592bb";-->

<!--      fetch(`https://ipinfo.io/${data.ip}`, {-->
<!--        headers: {-->
<!--          "Authorization": `Bearer ${token}`-->
<!--        }-->
<!--      })-->
<!--        .then(res => res.json())-->
<!--        .then(data => {-->
<!--          console.log(data.country);-->
<!--          isBY= data.country ==='BY'-->
<!--        })-->
<!--        .catch(err => {-->
<!--          console.error("Error fetching IP info:", err);-->
<!--        });-->
<!--    });-->
<!--</script>-->

<Layout>
  <div>clientIP: {clientIP}</div>
  <PopUp id={MODAL_DATA.CONTACT_MODAL_ID} />
  <Main />
  <Benefits />
  <Reasons />
  <Media isBY={isBY} />
</Layout>

<script>
  import { MODAL_DATA } from "../shared/data/modal_data";

  const modalElement = document.querySelector(
    `#${MODAL_DATA.CONTACT_MODAL_ID}`
  );
  modalElement?.addEventListener("close", () => {
    document.body.style.overflow = "auto";
  });
</script>
