---
import Layout from "../layouts/Layout.astro";
import Main from "../components/Main.astro";
import Benefits from "../components/Benefits.astro";
import Reasons from "../components/Reasons.astro";
import Media from "../components/Media.astro";
import PopUp from "../shared/components/Modal.astro";
import WelcomeModal from "../shared/components/WelcomeModal.astro";
import { MODAL_DATA } from "../shared/data/modal_data";
import "../styles/reset.css";
---

<Layout>
  <WelcomeModal id={MODAL_DATA.WELCOME_MODAL_ID} />
  <PopUp id={MODAL_DATA.CONTACT_MODAL_ID} />
  <Main />
  <Benefits />
  <Reasons />
  <Media />
</Layout>

<script>
  import { openModal } from "free-astro-components";
  import { MODAL_DATA } from "../shared/data/modal_data";

  const WELCOME_MODAL_STORAGE_KEY = "welcome_modal_shown";

  const welcomeModal = document.querySelector(
    `#${MODAL_DATA.WELCOME_MODAL_ID}`
  );
  if (welcomeModal) {
    welcomeModal.addEventListener("close", () => {
      document.body.style.overflow = "auto";
      localStorage.setItem(WELCOME_MODAL_STORAGE_KEY, "1");
    });

    let shown = false;
    try {
      shown = localStorage.getItem(WELCOME_MODAL_STORAGE_KEY) === "1";
    } catch {
      shown = false;
    }

    if (!shown) {
      openModal(welcomeModal);
    }
  }

  const modalElement = document.querySelector(
    `#${MODAL_DATA.CONTACT_MODAL_ID}`
  );
  modalElement?.addEventListener("close", () => {
    document.body.style.overflow = "auto";
  });

  function applyGeo(isBY: boolean) {
    document
      .querySelectorAll<HTMLElement>("[data-only='by']")
      .forEach((el) => (el.style.display = isBY ? "" : "none"));
    document
      .querySelectorAll<HTMLElement>("[data-only='other']")
      .forEach((el) => (el.style.display = isBY ? "none" : ""));
  }

  window.addEventListener("geo:by", (e: Event) =>
    applyGeo((e as CustomEvent<{ isBY: boolean }>).detail.isBY)
  );

  (async () => {
    try {
      const token = "cc6c23fd5592bb";
      const res = await fetch("https://ipinfo.io/json", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      const isBY = data?.country === "BY";

      document.documentElement.dataset.isBy = isBY ? "1" : "0";
      window.dispatchEvent(new CustomEvent("geo:by", { detail: { isBY } }));
    } catch (e) {
      console.error("Geo check failed:", e);
      applyGeo(false);
    }
  })();
</script>
